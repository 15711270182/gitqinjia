<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="divport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no">
    <title>开通完美亲家相亲次卡</title>



    <script>
        (function (win, doc) {
            function setFontSize() {
                // 获取window 宽度
                // zepto实现 $(window).width()就是这么干的
                var docEl = doc.documentElement;
                var clientWidth = docEl.clientWidth;
                if (clientWidth <= 640) {
                    docEl.style.fontSize = 30 * (clientWidth / 640) + 'px';
                } else {
                    docEl.style.fontSize = 30 + "px";
                }
            }
            var resizeEvt = 'orientationchange' in window ? 'orientationchange' : 'resize';
            var timer = null;
            win.addEventListener(resizeEvt, function () {
                clearTimeout(timer);
                timer = setTimeout(setFontSize, 300);
            }, false);
            win.addEventListener("pageshow", function (e) {
                if (e.persisted) {
                    clearTimeout(timer);
                    timer = setTimeout(setFontSize, 300);
                }
            }, false);
            // 初始化
            setFontSize();
        }(window, document));
    </script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>

        *{margin: 0;padding: 0;}
        body{font-family: PingFangSC-Medium, PingFang SC;width: 30rem;height: 53.36rem;background: rgb(0,0,0,0.8);}
        #container{background-image: url("https://pics.njweiyi6.com/wmqj2/bg_cont2.png");width: 32.7rem;height:43.8rem;background-repeat: no-repeat;background-size: cover;position: fixed;bottom: 0;padding: 1.2rem 0 0 0;}
        #container .title{font-size: 1.6rem;font-weight: bold;color: #202020;line-height: 2.4rem;text-align: center}
        #container .subtitle{font-size: 2.24rem;font-family: MicrosoftYaHei-Bold, MicrosoftYaHei;font-weight: bold;color: #F7424A;line-height: 3.04rem;letter-spacing: 0.08rem;margin: 1.92rem 0 0.32rem 0;text-align:center;}
        #container .original_price{height: 2.08rem;font-size: 1.6rem;font-family: MicrosoftYaHei;color: #F7424A;line-height: 2.08rem;letter-spacing: 0.08rem;text-align: center;text-decoration: line-through;}
        #container .count_title{font-size: 1.2rem;font-weight: bold;color: #202020;line-height: 1.68rem;margin: 2.08rem 0 2.56rem 0.96rem;}
        #container .content{display:flex;justify-content:space-between;padding:0 1.2rem;}
        #container .content .item{width: 8.72rem;height: 9.44rem;background: #FFFFFF;border-radius: 0.64rem;border: 0.08rem solid #D6D6D6;position: relative;}
        #container .content .on{background: #FFF6EE;border: 0.08rem solid #FFBF74}
        #container .content .item .save_price{width: 4.88rem;height: 1.6rem;background: #FF4F57;border-radius: 0.25rem 0.25rem 0.25rem 0;font-size: 0.96rem;font-weight: 400;color: #FFFFFF;line-height: 1.6rem;text-align: center;position: absolute;top: -0.8rem;left: -0.08rem;display:none}
        #container .content .item .show{display: block;}
        #container .content .item .top{display: flex;justify-content:center;margin: 1.28rem 0 0 0;position:relative;}
        #container .content .item .top .d1{font-size: 3.2rem;font-weight: bold;color: #202020;line-height: 3.2rem;}
        #container .content .item .top .d2{font-size: 1.92rem;font-weight: bold;color: #202020;line-height: 3.2rem;}
        #container .content .item .top::after{content:'';position: absolute;left: 0.8rem;bottom: -0.48rem;right: 0;width: 7.12rem;height: 0.01rem;background-color: #E1E1E1;}
        #container .content .item .bottom .d1{font-size: 1.28rem;font-weight: bold;color: #606060;line-height: 1.44rem;margin: 1.12rem 0 0.32rem ;text-align: center;}
        #container .content .item .bottom .d2{font-size: 1.12rem;font-weight: 400;color: #909090;line-height: 1.28rem;text-align: center;}
        #container .content .item .color{color:#FF4F57 !important;}
        #container .bot_{width: 30rem;height: 4.8rem;background: linear-gradient(180deg, #FF4F57 0%, #F13840 100%);border-radius: 2.4rem;font-size: 1.6rem;font-weight: bold;color: #FFFFFF;line-height: 4.8rem;text-align: center;margin:5.28rem auto 0;}



    </style>
</head>

<body>
    <div id="container">
        <div class="title">联系对方需购买联系次数</div>
        <div class="subtitle">限时优惠5元起</div>
        <div class="original_price">原价<span class="op">20</span>元</div>
        <div class="count_title">次数套餐</div>
        <div class="content">
            {foreach $list as $k=>$v}
            <div class="{$k== 0?'item on':'item'}" onclick="show(this)" pay_id="{$v.id}" num="{$v.num}" discount="{$v.discount}" price="{$v.price}">
                <div class="{$k== 0?'save_price show':'save_price'}">立省<span>{$v.old_price}</span>元</div>
                <div class="top">
                    <div class="{$k== 0?'d1 color':'d1'}">{$v.num}</div>
                    <div class="{$k== 0?'d2 color':'d2'}">个</div>
                </div>
                <div class="bottom">
                    <div class="{$k== 0?'d1 color':'d1'}">{$v.day_price}元/个</div>
                    <div class="d2">限时{$v.discount}折</div>
                </div>
            </div>
            {/foreach}
        </div>
        <div class="bot_"><span class="dis">4</span>折优惠购(<span class="mon">8</span>元)</div>
    </div>
    <script>
        var uid = getQueryStringByName('uid');
        var openid = getQueryStringByName('openid');
        window.submit_status = 2;


        function show(e){
            let num = $(e).attr("num");//多少个
            let discount = $(e).attr("discount");//几折
            let price = $(e).attr("price");//价格

            $(".original_price .op").html(num*20);
            $(".bot_ .dis").html(discount);
            $(".bot_ .mon").html(price/100);


            //选中变色
            $(".item").attr("class", "item");
            $(".save_price").attr("class", "save_price");
            $(".top .d1").attr("class", "d1");
            $(".top .d2").attr("class", "d2");
            $(".bottom .d1").attr("class", "d1");


            $(e).attr("class", "item on");
            $(e).children(".save_price").attr("class", "save_price show");
            $(e).children(".top").children(".d1").attr("class", "d1 color");
            $(e).children(".top").children(".d2").attr("class", "d2 color");
            $(e).children(".bottom").children(".d1").attr("class", "d1 color");

        }
        function getQueryStringByName(name) {
            var result = window.location.search.match(new RegExp("[\?\&]" + name + "=([^\&]+)", "i"));
            if (result == null || result.length < 1) {
                return "";
            }
            return result[1];
        }

        $(".bot_").click( function () {
            if(window.submit_status==1){
                alert("操作过于频繁，稍后再试")

                return;
            }
            window.submit_status = 1;
            setTimeout(()=> {
                window.submit_status=2;
            },4000)
            let pay_id = $(".on").attr("pay_id");

            $.ajax({
                'url': 'https://testqin.njzec.com/api/order/makeorderh5?uid=' + uid + "&openid=" + openid + "&goods_id=" + pay_id,
                'dataType': 'json',
                success: function (result) {
                    var res = JSON.parse(result);
                    console.log(res.data);
                    let code = res.errcode;
                    if (200 != code) {
                        alert(res.errmsg);
                        return;
                    }

                    if (typeof WeixinJSBridge == "undefined") {
                        if (document.addEventListener) {
                            document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
                        } else if (document.attachEvent) {
                            document.attachEvent('WeixinJSBridgeReady', onBridgeReady);
                            document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
                        }
                    } else {
                        onBridgeReady(res);
                    }
                },
                error: function (e) { }
            });
            // console.log(pay_id,uid,openid);
        })

        function onBridgeReady(res) {
            WeixinJSBridge.invoke(
                'getBrandWCPayRequest', {
                appId: res.data.appId, //公众号名称，由商户传入
                timeStamp: res.data.timeStamp, //时间戳，自1970年以来的秒数
                nonceStr: res.data.nonceStr, //随机串
                package: res.data.package, //prepay_id用等式的格式
                signType: res.data.signType, //微信签名方式：
                paySign: res.data.paySign, //微信签名
            }, function (resa) {
                if(resa.err_msg != "get_brand_wcpay_request:cancel"){
                    window.location.href ="weixin://dl/business/?t=JMrZhBwDCXl"
                }
            })
        }
    </script>
</body>

</html>